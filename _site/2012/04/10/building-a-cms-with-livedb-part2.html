<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="/images/favicon.ico">
	<link rel="stylesheet" href="/css/bootstrap.min.css">
	<link rel="stylesheet" href="/stylesheets/pygment_trac.css">
	<link rel="stylesheet" href="/stylesheets/stylesheet.css">
	

    <title>Building a CMS with LiveDB - part 2 - OrigoDB</title>


    <!-- Custom styles for this template -->
    <link href="starter-template.css" rel="stylesheet">


    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>
  
  <a href="https://github.com/devrexlabs"><img style="position: absolute; top: 40px; right: 0; border: 0;" src="https://camo.githubusercontent.com/652c5b9acfaddf3a9c326fa6bde407b87f7be0f4/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"></a>

    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>

                  <a class="brand" href="/" style="float: left; font-size: small">
                    <img style="margin-top: 12px; margin-left:16px; height: 26px; width: 26px" src="/images/origodb.png" /></a>

        </div>
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
		<li><a class="brand" href="/">Start</a></li>
		  <li><a href="/intro">Intro</a></li>
			<li><a href="/examples">Examples</a></li>
			<li><a href="/repos">Repositories</a></li>
			<li><a href="/docs">Documentation</a></li>
			<!-- <li><a href="/blog">Blog</a></li> -->
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

    <div class="container">

      <div class="starter-template">
		<h1 id="building-a-cms-with-livedb---part-2">Building a CMS with LiveDB - part 2</h1>
<p>Welcome to part 2 of this series. In <a href="">part 1</a>, we set up a very simple model containing a Dictionary of Page objects. In this article we will extend the model to handle hierarchical menus. A complete VS2010 solution is available for download below. Let’s start by having a closer look at the requirements specifically related to menus.</p>

<ul>
  <li><em>Multiple Hierarchical menus</em> – Hierachical means that menus can contain submenus to an arbitrary depth. We’ll solve this by using plain old object oriented inheritance and composition. Multiple means the customer wants to display different menus on different parts of the site. More than one menu may link to the same page or url.</li>
  <li><em>Define and use templates for content</em> – When creating a new page, the user can start with an empty page or copy a page from a list of templates. The list of templates will be implemented as a menu with a designated name. This will be handled at the application level and falls outside the scope of our model.</li>
  <li><em>Manage mail message templates</em> – Same as for content templates.</li>
  <li><em>Independent menus for different sub-sites</em> – see first bullet point.</li>
</ul>

<h2 id="entities">Entities</h2>
<p>Lets begin by adding entity classes needed to represent the hierarchical menus. You might recognize the Composite design pattern in the following class diagram:</p>

<p><img src="/images/building-cms-2.png" /></p>

<p>A MenuItem has a name which is used to identify the top level menu objects or as a display name when the menu is rendered. An InternalMenuItem references a Page object by using the page’s key field. We could also have chosen to store a direct object reference but you will see later how this is a better choice.</p>

<p>These classes are pretty straight forward and anemic, so for brevity, only one listing is provided, ExternalMenuItem.  (The complete VS2010 project is available  for download at the end of the article.)  We’re cutting some corners here with this loose anemic design. Initially we started out with an immutable  design using readonly fields and validation logic in the constructors. That could have gotten us into more trouble later on than the anemic design will,  for example issues with JSON serialization and automapping to strongly typed views in ASP.NET MVC. It’s probably a good idea to redesign later when the overall architecture has settled.</p>

<div class="highlight"><pre><code class="csharp"><span class="na">[Serializable]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ExternalMenuItem</span> <span class="p">:</span> <span class="n">MenuItem</span>
<span class="p">{</span>
	<span class="k">public</span> <span class="kt">string</span> <span class="n">Url</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

<span class="p">}</span></code></pre></div>

<h2 id="adding-a-menu-collection-to-the-model-and-versioning">Adding a menu collection to the model and versioning</h2>
<p>Next, we add a dictionary field to the CmsModel class mapping menu names to menus and initialize it in the constructor. However, this will not work when we load a snapshot created from a previous version of the model, because the default serializer doesn’t call the constructor during deserialization! There are two solutions to this problem, we can override SnapshotRestored and assign the field if it is null or we can delete all the snapshots forcing the engine to create a new instance of the model and replay the entire sequence of commands. Let’s use the former approach.</p>

<p>We will use Put and Remove methods for menus as we did for pages. We can add methods for partial menu modification later if necesssary, but let´s keep it as simple as possible until we have a good reason to do otherwise. Here is a listing of the modified CmsModel class.</p>

<script src="https://gist.github.com/rofr/ca9a57cd79ed8ee4e1ba.js"> </script>

<h2 id="menu-commands">Menu commands</h2>
<p>The Put and Remove commands are really simple, no explanation needed.</p>

<script src="https://gist.github.com/rofr/b4b3e4eababf619cf30b.js"> </script>

<h2 id="start-your-engines">Start your engines!</h2>
<p>Finally, lets look at some test code that creates and adds a menu to the model. One interesting thing to note here is that the engine deserializes a snapshot and a number of commands created from the previous version of the code. The commands haven’t changed so this is not a problem, and we fixed the model by overriding SnapshotRestored. I’ll elaborate on schema evolution in a future part of this series.</p>

<p>Another thing to notice is that the menu being created is a fairly complex object graph, at least when it comes to O/R mapping. Using #liveDB you can just forget about relational modeling and O/R mapping altogether and focus on basic object-oriented modeling.</p>

<script src="https://gist.github.com/rofr/03e635ddb6beea5dae7d.js"> </script>

<p>Thanks for tuning in, and feel free to add your comment below! <a href="/LiveDomain.Cms.Core-part2.zip">Download zipped VS2010 project</a></p>


		
<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'devrexlabsgithubio'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
		
		
      </div>
		<div class="well well-sm">
		&copy; Devrex Labs | OrigoDB - In-memory database toolkit for NET/Mono | Build faster systems, faster 
		</div>

    </div><!-- /.container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
  </body>
</html>
	